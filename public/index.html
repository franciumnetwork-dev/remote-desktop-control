<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Remote Desktop Control</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      overflow: hidden;
      width: 100vw;
      height: 100vh;
    }
    /* The video element fills the screen */
    #theScreen {
      display: block;
      width: 100%;
      height: 100%;
      background: black;
    }
  </style>
</head>
<body>
  <!-- Using a video element (no controls) -->
  <video id="theScreen" autoplay muted></video>
  <script>
    // Retrieve key (or prompt)
    const key = new URLSearchParams(window.location.search).get('key') || prompt("Enter the key:");
    const parsedDem = atob(key.slice(32));
    var width = parseInt(parsedDem.split("x")[0]);
    var height = parseInt(parsedDem.split("x")[1]);
    var socket;
    let isConnected = false;

    // Setup MediaSource to receive video (WebM VP8)
    const video = document.getElementById('theScreen');
    const mediaSource = new MediaSource();
    video.src = URL.createObjectURL(mediaSource);
    let sourceBuffer;
    mediaSource.addEventListener('sourceopen', () => {
      sourceBuffer = mediaSource.addSourceBuffer('video/webm; codecs="vp8"');
    });

    function innitWithKey(key) {
      // Connect to WS using the complementary key (append "browser")
      socket = new WebSocket(`wss://remote-desktop-control.onrender.com/key/${key}browser`);
      socket.binaryType = 'arraybuffer';

      socket.addEventListener('open', () => {
        console.log('Connected to WebSocket server');
        isConnected = true;
      });

      socket.addEventListener('close', () => {
        isConnected = false;
        console.log('WebSocket closed. Retrying in 2 seconds...');
        setTimeout(() => innitWithKey(key), 2000);
      });

      socket.addEventListener('error', (err) => {
        console.error('WebSocket error:', err);
      });

      socket.addEventListener('message', (event) => {
        try {
          const data = JSON.parse(event.data);
          // When a video packet is received, decode and append it
          if (data.videoPacket && sourceBuffer && !sourceBuffer.updating) {
            const binary = Uint8Array.from(atob(data.videoPacket), c => c.charCodeAt(0));
            sourceBuffer.appendBuffer(binary);
          }
        } catch (err) {
          console.error('Error parsing message:', err);
        }
      });

      // Prevent pausing: if the video is paused, immediately play
      video.addEventListener('pause', () => {
        video.play();
      });

      // Control event listeners (mouse & keyboard)
      video.addEventListener('mousemove', (e) => {
        const rect = video.getBoundingClientRect();
        const x =  Math.floor((e.clientX - rect.left) * width / window.innerWidth);
        const y = Math.floor((e.clientY - rect.top) * height / window.innerHeight);
        if (isConnected) {
          socket.send(JSON.stringify({ action: 'moveMouse', data: `${x}X${y}` }));
        }
      });

      video.addEventListener('mousedown', (e) => {
        const rect = video.getBoundingClientRect();
        const x =  Math.floor((e.clientX - rect.left) * width / window.innerWidth);
        const y = Math.floor((e.clientY - rect.top) * height / window.innerHeight);
        let buttonName = getMouseButton(e.button);
        if (isConnected) {
          socket.send(JSON.stringify({ action: 'holdMouse', data: `${x}X${y}Y${buttonName}` }));
        }
        e.preventDefault();
      });

      video.addEventListener('mouseup', (e) => {
        const rect = video.getBoundingClientRect();
        const x =  Math.floor((e.clientX - rect.left) * width / window.innerWidth);
        const y = Math.floor((e.clientY - rect.top) * height / window.innerHeight);
        let buttonName = getMouseButton(e.button);
        if (isConnected) {
          socket.send(JSON.stringify({ action: 'releaseMouse', data: `${x}X${y}Y${buttonName}` }));
        }
        e.preventDefault();
      });

      const heldKeys = new Set();
      window.addEventListener('keydown', (e) => {
        if (!heldKeys.has(e.key)) {
          heldKeys.add(e.key);
          if (isConnected) {
            socket.send(JSON.stringify({ action: 'holdKey', data: e.key }));
          }
        }
        e.preventDefault();
      });

      window.addEventListener('keyup', (e) => {
        if (heldKeys.has(e.key)) {
          heldKeys.delete(e.key);
          if (isConnected) {
            socket.send(JSON.stringify({ action: 'releaseKey', data: e.key }));
          }
        }
        e.preventDefault();
      });

      document.addEventListener('keydown', (e) => e.preventDefault());
      document.addEventListener('contextmenu', (e) => e.preventDefault());
    }

    function getMouseButton(button) {
      switch (button) {
        case 0:
          return "left";
        case 1:
          return "middle";
        case 2:
          return "right";
        default:
          return "left";
      }
    }

    innitWithKey(key);
  </script>
</body>
</html>
